/* LIMPEZA PREVIA DAS TRIGGERS ANTIGAS
REMOVE TODAS AS TRIGGERS DE USUARIO CUJO NOME TERMINA COM '_AIUD0' */
EXECUTE BLOCK AS
DECLARE VARIABLE VTRIGGER VARCHAR(64);
DECLARE VARIABLE VCOUNT INTEGER;
BEGIN
    SELECT COUNT(*) FROM RDB$TRIGGERS
    WHERE RDB$SYSTEM_FLAG = 0 AND TRIM(RDB$TRIGGER_NAME) LIKE '%_AIUD0'
    INTO :VCOUNT;
    
    WHILE (:VCOUNT > 0) DO
    BEGIN
        SELECT FIRST 1 TRIM(RDB$TRIGGER_NAME) FROM RDB$TRIGGERS
        WHERE RDB$SYSTEM_FLAG = 0 AND TRIM(RDB$TRIGGER_NAME) LIKE '%_AIUD0'
        INTO :VTRIGGER;
        EXECUTE STATEMENT 'DROP TRIGGER ' || :VTRIGGER;
        :VCOUNT = :VCOUNT - 1;
    END
END; COMMIT;

/* LIMPEZA PREVIA DE OBJETOS ANTIGOS
REMOVE TODAS AS PROCEDURES, TABELAS E SEQUENCIAS DA VERSAO ANTERIOR DO SCRIPT */
EXECUTE BLOCK AS BEGIN IF (EXISTS(SELECT 1 FROM RDB$PROCEDURES WHERE TRIM(RDB$PROCEDURE_NAME) = 'LOGTABELAPRECO_AIUD0'))
THEN EXECUTE STATEMENT 'DROP PROCEDURE LOGTABELAPRECO_AIUD0'; END; COMMIT;
EXECUTE BLOCK AS BEGIN IF (EXISTS(SELECT 1 FROM RDB$RELATIONS WHERE TRIM(RDB$RELATION_NAME) = 'LOGTABELAPRECO'))
THEN EXECUTE STATEMENT 'DROP TABLE LOGTABELAPRECO'; END; COMMIT;
EXECUTE BLOCK AS BEGIN IF (EXISTS(SELECT 1 FROM RDB$GENERATORS WHERE TRIM(RDB$GENERATOR_NAME) = 'GLOGTABELAPRECO'))
THEN EXECUTE STATEMENT 'DROP GENERATOR GLOGTABELAPRECO'; END; COMMIT;
EXECUTE BLOCK AS BEGIN IF (EXISTS(SELECT 1 FROM RDB$RELATIONS WHERE TRIM(RDB$RELATION_NAME) = 'LOGTABELA'))
THEN EXECUTE STATEMENT 'DROP TABLE LOGTABELA'; END; COMMIT;

/* CRIA A TABELA DE MAPEAMENTO DE CAMPOS
ESSA TABELA ARMAZENA A DEFINICAO DE NOMES DAS TABELAS E CAMPOS */
CREATE TABLE LOGTABELA (
    TABELA VARCHAR(64) NOT NULL,
    ALIASTABELA VARCHAR(150) NOT NULL,
    CAMPO VARCHAR(1000) NOT NULL,
    ALIASCAMPO VARCHAR(1000) NOT NULL
); COMMIT;

INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPGRAU', 'Tabela de Desconto e Preco (Grau)', 'TBPCODIGO;PROCODIGO;TBPSEQ;ESFINICIAL;ESFFINAL;TBPPRECO;TBPDESC;', 'Tabela;Produto;Sequencial;Esf.Inicial;Esf.Final;Preco;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TABPRECO', 'Tabela de Desconto e Preco (Principal)', 'TBPCODIGO;TBPDESCRICAO;TBPTIPO;TBPFECH;TBPDTVALIDADE;TBPSITUACAO;TBPTABCOMB;TBPDTINICIO;', 'Tabela;Descricao;Tipo;Fechamento;Dt.Validade;Situacao;Combinado;Dt.Inicio;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPSERVI', 'Tabela de Desconto e Preco (Aba Servico)', 'TBPCODIGO;SERCODIGO;TBSVALOR;TBSPCDESCTO;', 'Tabela;Servico;Preco;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TABPRECOCOMPRA', 'Tabela de Desconto e Preco de Compra', 'TPCCODIGO;TPCDESCCRICAO;TPCVALIDADE;TPCSITUACAO;', 'Tabela;Descricao;Dt.Validade;Situacao;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITBDESC', 'Tabela de Desconto do Cliente no Faturamento', 'CLICODIGO;EMPCODIGO;CLEPCDESCTO;', 'Cliente;Empresa;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITBPCOMPRA', 'Tabelas de Preco do Fornecedor', 'TPCCODIGO;CLICODIGO;', 'Tabela;Cliente;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITBP', 'Tabelas de Preco do Cliente', 'CLICODIGO;TBPCODIGO;TBPDESCFECH;TBPDESC;TBPDESC2;TBPDTCADASTRO;TBPDTINICIO;TBPDTVALIDADE;', 'Cliente;Tabela;Fechamento;Desconto;Desconto2;Dt.Cadastro;Dt.Inicio;Dt.Validade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITBPCOMB', 'Tabelas de Precos Combinados', 'CLICODIGO;TBPCODIGO;TBPDESCFECH;TBPDESC;TBPDESC2;CLITBPCOMBDTCADASTRO;', 'Cliente;Tabela;Fechamento;Desconto;Desconto2;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITBPE', 'Tabelas de Preco do Fornecedor', 'CLICODIGO;TBPCODIGO;TBPDTCADASTRO;', 'Cliente;Tabela;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLICOMBPROPRO', 'Combinacao de Produtos e Produtos do Cliente', 'CLICODIGO;PROCODIGOA;CCINDICEPROA;CCINDICEPROA2;CCPCOVENDAPROA;CCPCOVENDAPROA2;PROCODIGOB;CCINDICEPROB;CCINDICEPROB2;CCPCOVENDAPROB;CCPCOVENDAPROB2;CCPDTCADASTRO;', 'Cliente;ProdutoA;Desconto ProdutoA;Desconto2 ProdutoA;Preco ProdutoA;Preco2 ProdutoA;ProdutoB;Desconto ProdutoB;Desconto2 ProdutoB;Preco ProdutoB;Preco2 ProdutoB;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLICOMBPROSER', 'Combinacao de Produtos e Servicos do Cliente', 'CLICODIGO;PROCODIGO;CCINDICEPRO2;CCINDICEPRO;CCPCOVENDAPRO;CCPCOVENDAPRO2;SERCODIGO;CCPCOVENDASER;CCINDICESER;CCDTCADASTRO;', 'Cliente;Produto;Desconto2 Produto;Desconto Produto;Preco Produto;Preco2 Produto;Servico;Preco Servico;Desconto Servico;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLIPRO', 'Produtos dos Clientes', 'CLICODIGO;PROCODIGO;CPINDICE2;CPPCOVENDA;CPPCOVENDA2;CPINDICE;CPDESCFECH;CPDTCADASTRO;', 'Cliente;Produto;Desconto2;Preco;Preco2;Desconto;Fechamento;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLISER', 'Servicos dos Clientes', 'CLICODIGO;SERCODIGO;CSPCOVENDA;CSINDICE;CSDTCADASTRO;', 'Cliente;Servico;Preco;Desconto;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TABDESCORIGEMPD', 'Desconto Geral do Cliente pela Origem do Pedido', 'CLICODIGO;TDOORIGEM;TDOPCDESC;TBPCODIGO;TDOID;', 'Cliente;Origem;Desconto;Tabela;ID;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TDOTBP', 'Tabelas de Desconto e Preco do Cliente por Origem do Pedido', 'TDOID;TBPCODIGO;TTDTCADASTRO;', 'ID;Tabela;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXAPCOPRODU', 'Valor de Montagem por Faixa de Valor do Pedido (Produtos)', 'PROCODIGO;FXSERSEQ;FXSERVRPEDINI;FXSERVRPEDFIM;FXSERVRSERVICO;', 'Produto;Sequencial;Valor Inicial;Valor Final;Preco;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXAPCOSERVI', 'Valor de Montagem por Faixa de Valor do Pedido (Servicos)', 'SERCODIGO;FXSERSEQ;FXSERVRPEDINI;FXSERVRPEDFIM;FXSERVRSERVICO;', 'Servico;Sequencial;Valor Inicial;Valor Final;Preco;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXACILPRODU', 'Faixa de Cobranca de Grau Cilindrico Estendido (Produtos)', 'PROCODIGO;FXCPROSEQ;FXCPROCILINI;FXCPROCILFIM;FXCPROVRPRODU;FXCPROTIPOQTD;FXCPROQTDFIXA;FXCPROPROCESSO;', 'Produto;Sequencial;Cil.Inicial;Cil.Final;Preco;Tipo;Quantidade;Processo;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXACILSERVI', 'Faixa de Cobranca de Grau Cilíndrico Estendido (Servicos)', 'SERCODIGO;FXCSERSEQ;FXCSERCILINI;FXCSERCILFIM;FXCSERVRSERVI;FXCSERTIPOQTD;FXCSERQTDFIXA;FXCSERPROCESSO;', 'Servico;Sequencial;Cil.Inicial;Cil.Final;Preco;Tipo;Quantidade;Processo;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXAPRISMAPRODU', 'Faixa de Cobranca de Prisma (Produtos)', 'PROCODIGO;FXPPROSEQ;FXPPROPRISMAINI;FXPPROPRISMAFIM;FXPPROPRISMAEIXO;FXPPROPRISMABASE;FXPPROVRPRODU;FXPPROTIPOQTD;FXPPROQTDFIXA;', 'Produto;Sequencial;Prisma Inicial;Prisma Final;Eixo;Base;Preco;Tipo;Quantidade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXAPRISMASERVI', 'Faixa de Cobrança de Prisma (Servicos)', 'SERCODIGO;FXPSERSEQ;FXPSERPRISMAINI;FXPSERPRISMAFIM;FXPSERPRISMAEIXO;FXPSERPRISMABASE;FXPSERVRSERVI;FXPSERTIPOQTD;FXPSERQTDFIXA;', 'Servico;Sequencial;Prisma Inicial;Prisma Final;Eixo;Base;Preco;Tipo;Quantidade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPCOMBPROSER', 'Tabela de Desconto e Preco Combinado (Servicos)', 'TBPCODIGO;PROCODIGO;CCINDICEPRO2;CCINDICEPRO;CCPCOVENDAPRO;CCPCOVENDAPRO2;SERCODIGO;CCPCOVENDASER;CCINDICESER;', 'Tabela;Produto;Desconto2 Produto;Desconto Produto;Preco Produto;Preco2 Produto;Servico;Preco Servico;Desconto Servico;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPGRUPO', 'Tabela de Desconto e Preco (Grupo Produtos)', 'TBPCODIGO;GR1CODIGO;GR2CODIGO;GR3CODIGO;GR4CODIGO;TBGSEQ;TBGPCDESCTO;TBGPCDESCTO2;MARCODIGO;TBPNGRUPO;TBPNVALOR;', 'Tabela;Grupo1;Grupo2;Grupo3;Grupo4;Sequencial;Desconto;Desconto2;Marca;N-Grupo;N-Valor;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPPRODU', 'Tabela de Desconto e Preco (Aba Produto)', 'TBPCODIGO;PROCODIGO;TBPPCOVENDA;TBPPCDESCTO2;TBPPCOVENDA2;TBPPCDESCTO;', 'Tabela;Produto;Preco;Desconto2;Preco2;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPMMPRODU', 'Tabela de Preco Maximo e Minimo', 'TBPCODIGO;TBPPROCODIGO;TBPPCOMAXIMO;TBPPCOMINIMO;', 'Tabela;Produto;Preco Max.;Preco Min.;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPMMREG', 'Cadastro de Regiao', 'TBPREGCODIGO;TBPCODIGO;', 'Regiao;Tabela;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPQTD', 'Tabela de Desconto e Preco (Quantidade)', 'TBPCODIGO;PROCODIGO;TBPSEQ;TBPQTDINICIAL;TBPQTDFINAL;TBPQTDVALOR;TBPQTDDESCT;', 'Tabela;Produto;Sequencial;Quant.Inicial;Quant.Final;Preco;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLITPPED', 'Desconto Geral de Produtos do Cliente/Tp. Pedido', 'CLICODIGO;TPCODIGO;PGTCODIGO;TBFCODIGO;BCOCODIGO;CTPSTATUS;CTPPCDESCTO;COBCODIGO;CTPPCDESCTOSER;FUNCODIGO;FUNCODIGO2;CTPPERCFATPROD;CTPPERCFATSER;', 'Cliente;Tipo;Pagamento;Fechamento;Banco;Status;Desconto Produto;Cobranca;Desconto Servico;Funcionario;Funcionario2;Desconto Fat.Produto;Desconto Fat.Servico;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CTPCOMBPROPRO', 'Combinacao de Produtos e Produtos/Tp. Pedido', 'CLICODIGO;PROCODIGOA;CCINDICEPROA;CCINDICEPROA2;CCPCOVENDAPROA;CCPCOVENDAPROA2;PROCODIGOB;CCINDICEPROB;CCINDICEPROB2;CCPCOVENDAPROB;CCPCOVENDAPROB2;CCPTPPEDID;CCPDTCADASTRO;', 'Cliente;ProdutoA;Desconto ProdutoA;Desconto2 ProdutoA;Preco ProdutoA;Preco2 ProdutoA;ProdutoB;Desconto ProdutoB;Desconto2 ProdutoB;Preco ProdutoB;Preco2 ProdutoB;Tipo;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CTPCOMBPROSER', 'Combinacao de Produtos e Servicos/Tp. Pedido', 'CLICODIGO;PROCODIGO;CCINDICEPRO2;CCINDICEPRO;CCPCOVENDAPRO;CCPCOVENDAPRO2;SERCODIGO;CCPCOVENDASER;CCINDICESER;CCPTPPEDID;CCDTCADASTRO;', 'Cliente;Produto;Desconto2 Produto;Desconto Produto;Preco Produto;Preco2 Produto;Servico;Preco Servico;Desconto Servico;Tipo;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CTPPRO', 'Produtos do Clientes/Tp. Pedido', 'CLICODIGO;TPCODIGO;PROCODIGO;CPINDICE2;CPPCOVENDA;CPPCOVENDA2;CPINDICE;CPDESCFECH;CPDTCADASTRO;', 'Cliente;Tipo;Produto;Desconto2;Preco;Preco2;Desconto;Fechamento;Dt.Cadastro;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXADESPRODU', 'Faixa de cobranca de descentracao (Produtos)', 'PROCODIGO;FXCPROSEQ;FXCPRODESINI;FXCPRODESFIM;FXCPROVRPRODU;FXCPROTIPOQTD;FXCPROQTDFIXA;', 'Produto;Sequencial;Descen.Inicial;Descen.Final;Preco;Tipo;Quantidade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('FAIXADESSERVI', 'Faixa de cobranca de descentracao (Servicos)', 'SERCODIGO;FXCSERSEQ;FXCSERDESINI;FXCSERDESFIM;FXCSERVRSERVI;FXCSERTIPOQTD;FXCSERQTDFIXA;', 'Servico;Sequencial;Descen.Inicial;Descen.Final;Preco;Tipo;Quantidade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TBPCOMBPROPRO', 'Tabela de Desconto e Preco Combinado (Produtos)', 'TBPCODIGO;PROCODIGOA;CCINDICEPROA;CCINDICEPROA2;CCPCOVENDAPROA;CCPCOVENDAPROA2;PROCODIGOB;CCINDICEPROB;CCINDICEPROB2;CCPCOVENDAPROB;CCPCOVENDAPROB2;', 'Tabela;ProdutoA;Desconto ProdutoA;Desconto2 ProdutoA;Preco ProdutoA;Preco2 ProdutoA;ProdutoB;Desconto ProdutoB;Desconto2 ProdutoB;Preco ProdutoB;Preco2 ProdutoB;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('TPCPRODU', 'Tabela de Desconto e Preco de Compra (Produtos)', 'PROCODIGO;TPCCODIGO;PRECO;DESCTO;', 'Produto;Tabela;Preco;Desconto;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CTPTBP', 'Tabela de Preco do Cliente por Tipo de Pedido', 'CLICODIGO;TPCODIGO;TBPCODIGO;TBPDESCFECH;TBPDESC;TBPDESC2;TBPDTCADASTRO;TBPDTINICIO;TBPDTVALIDADE;', 'Cliente;Tipo;Tabela;Fechamento;Desconto;Desconto2;Dt.Cadastro;Dt.Inicio;Dt.Validade;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('CLIEN', 'Cadastro do Cliente', 'CLICODIGO;CLITBPE;TBPCODIGO;CLIPCDESCTO;CLIPCDESCTOSER;CLIPCDESCPRODU;CLIPCDESCSERVI;', 'Cliente;Utiliza Tab.Descto.Fechamento;Tabela;Desc.Geral Produto;Desc.Geral Servico;Desc.Produto;Desc.Servico;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('PREMP_INTERNA', 'Cadastro do Produto', 'EMPCODIGO;PROCODIGO;PREPCOMEDIO;PREPCOCUSTO;PREPCOVENDA;PREPCOPROMOCAO;PREPCOVENDA2;PREPCOPROMO2;', 'Empresa;Produto;Preco Medio; Preco Custo;Preco;Preco Promo.;Preco2;Preco Promo2;');
INSERT INTO LOGTABELA (TABELA, ALIASTABELA, CAMPO, ALIASCAMPO) VALUES ('SERVI', 'Cadastro do Servico', 'SERCODIGO;SERVALOR;', 'Servico;Preco;');
COMMIT;

/* ATUALIZACAO DO PARAMETRO NO MODULOSPARAM
GARANTE QUE A PARAMETRIZACAO RELACIONADA AS ALTERACOES DE TABELA DE PRECO ESTEJA CRIADA */
UPDATE OR INSERT INTO MODULOSPARAM (NOME, VALOR, DESCRICAO, ID_VERSAO)
VALUES('ALTTABPCODESCPEDCLI', 'S', 'Alteracao na Tabela de Preco e Descto no Pedido do Cliente', 99)
MATCHING (NOME); COMMIT;

/* CRIA A TABELA DE LOG DETALHADO DAS ALTERACOES
ESSA TABELA SERA CONSUMIDA PELAS TRIGGERS DINAMICAS QUE SERAO GERADAS */
CREATE TABLE LOGTABELAPRECO (
    LTPID INTEGER,
    LTPTABELA VARCHAR(64) NOT NULL,
    LTPUSUCODIGO INTEGER NOT NULL,
    LTPDATAHORA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LTPLOCAL VARCHAR(150) NOT NULL,
    LTPACAO CHAR(1) NOT NULL,
    LTPCAMPO1 VARCHAR(64), LTPANTVALOR1 VARCHAR(100), LTPNOVOVALOR1 VARCHAR(100),
    LTPCAMPO2 VARCHAR(64), LTPANTVALOR2 VARCHAR(100), LTPNOVOVALOR2 VARCHAR(100),
    LTPCAMPO3 VARCHAR(64), LTPANTVALOR3 VARCHAR(100), LTPNOVOVALOR3 VARCHAR(100),
    LTPCAMPO4 VARCHAR(64), LTPANTVALOR4 VARCHAR(100), LTPNOVOVALOR4 VARCHAR(100),
    LTPCAMPO5 VARCHAR(64), LTPANTVALOR5 VARCHAR(100), LTPNOVOVALOR5 VARCHAR(100),
    LTPCAMPO6 VARCHAR(64), LTPANTVALOR6 VARCHAR(100), LTPNOVOVALOR6 VARCHAR(100),
    LTPCAMPO7 VARCHAR(64), LTPANTVALOR7 VARCHAR(100), LTPNOVOVALOR7 VARCHAR(100),
    LTPCAMPO8 VARCHAR(64), LTPANTVALOR8 VARCHAR(100), LTPNOVOVALOR8 VARCHAR(100),
    LTPCAMPO9 VARCHAR(64), LTPANTVALOR9 VARCHAR(100), LTPNOVOVALOR9 VARCHAR(100),
    LTPCAMPO10 VARCHAR(64), LTPANTVALOR10 VARCHAR(100), LTPNOVOVALOR10 VARCHAR(100),
    LTPCAMPO11 VARCHAR(64), LTPANTVALOR11 VARCHAR(100), LTPNOVOVALOR11 VARCHAR(100),
    LTPCAMPO12 VARCHAR(64), LTPANTVALOR12 VARCHAR(100), LTPNOVOVALOR12 VARCHAR(100),
    LTPCAMPO13 VARCHAR(64), LTPANTVALOR13 VARCHAR(100), LTPNOVOVALOR13 VARCHAR(100),
    CONSTRAINT XPKLOGTABELAPRECO PRIMARY KEY (LTPID)
); COMMIT;

CREATE INDEX LOGTABELAPRECO_DATA ON LOGTABELAPRECO (LTPDATAHORA);
CREATE INDEX LOGTABELAPRECO_TABELA ON LOGTABELAPRECO (LTPTABELA);
CREATE INDEX LOGTABELAPRECO_USUCODIGO ON LOGTABELAPRECO (LTPUSUCODIGO);
CREATE GENERATOR GLOGTABELAPRECO; COMMIT;

SET TERM ^ ; CREATE OR ALTER TRIGGER TBI_LOGTABELAPRECO FOR LOGTABELAPRECO
ACTIVE BEFORE INSERT POSITION 0 AS BEGIN
IF (NEW.LTPID IS NULL) THEN NEW.LTPID = NEXT VALUE FOR GLOGTABELAPRECO;
END^ SET TERM ; ^ COMMIT;

/* CRIA A PROCEDURE QUE REALIZA A AUDITORIA DAS TABELAS DE PRECO E SUAS DERIVADAS
RECEBE OS VALORES ANTIGOS/NOVOS DOS CAMPOS E GRAVA UMA LINHA DETALHADA NA TABELA LOGTABELAPRECO */
SET TERM ^ ;
CREATE PROCEDURE LOGTABELAPRECO_AIUD0(
    VTABELA VARCHAR(64), VUSUARIO INTEGER, VACAO CHAR(1),
    FIELD1 VARCHAR(64) DEFAULT NULL, OLD1 VARCHAR(100) DEFAULT NULL, NEW1 VARCHAR(100) DEFAULT NULL,
    FIELD2 VARCHAR(64) DEFAULT NULL, OLD2 VARCHAR(100) DEFAULT NULL, NEW2 VARCHAR(100) DEFAULT NULL,
    FIELD3 VARCHAR(64) DEFAULT NULL, OLD3 VARCHAR(100) DEFAULT NULL, NEW3 VARCHAR(100) DEFAULT NULL,
    FIELD4 VARCHAR(64) DEFAULT NULL, OLD4 VARCHAR(100) DEFAULT NULL, NEW4 VARCHAR(100) DEFAULT NULL,
    FIELD5 VARCHAR(64) DEFAULT NULL, OLD5 VARCHAR(100) DEFAULT NULL, NEW5 VARCHAR(100) DEFAULT NULL,
    FIELD6 VARCHAR(64) DEFAULT NULL, OLD6 VARCHAR(100) DEFAULT NULL, NEW6 VARCHAR(100) DEFAULT NULL,
    FIELD7 VARCHAR(64) DEFAULT NULL, OLD7 VARCHAR(100) DEFAULT NULL, NEW7 VARCHAR(100) DEFAULT NULL,
    FIELD8 VARCHAR(64) DEFAULT NULL, OLD8 VARCHAR(100) DEFAULT NULL, NEW8 VARCHAR(100) DEFAULT NULL,
    FIELD9 VARCHAR(64) DEFAULT NULL, OLD9 VARCHAR(100) DEFAULT NULL, NEW9 VARCHAR(100) DEFAULT NULL,
    FIELD10 VARCHAR(64) DEFAULT NULL, OLD10 VARCHAR(100) DEFAULT NULL, NEW10 VARCHAR(100) DEFAULT NULL,
    FIELD11 VARCHAR(64) DEFAULT NULL, OLD11 VARCHAR(100) DEFAULT NULL, NEW11 VARCHAR(100) DEFAULT NULL,
    FIELD12 VARCHAR(64) DEFAULT NULL, OLD12 VARCHAR(100) DEFAULT NULL, NEW12 VARCHAR(100) DEFAULT NULL,
    FIELD13 VARCHAR(64) DEFAULT NULL, OLD13 VARCHAR(100) DEFAULT NULL, NEW13 VARCHAR(100) DEFAULT NULL)
AS
    DECLARE VARIABLE VPLUGIN CHAR(1); DECLARE VARIABLE VKEY VARCHAR(64);
    DECLARE VARIABLE VKEYS VARCHAR(1000); DECLARE VARIABLE VLOCAL VARCHAR(150);
BEGIN
    SELECT FIRST 1 VALOR FROM MODULOSPARAM WHERE NOME = 'ALTTABPCODESCPEDCLI' INTO :VPLUGIN;
    IF (:VPLUGIN = 'S') THEN
    BEGIN
        SELECT FIRST 1 ALIASTABELA FROM LOGTABELA WHERE TABELA = :VTABELA INTO :VLOCAL;
        IF (VACAO = 'U') THEN
        BEGIN
            IF(
                (OLD1 != NEW1) OR (OLD2 != NEW2) OR (OLD3 != NEW3) OR (OLD4 != NEW4) OR (OLD5 != NEW5) OR
                (OLD6 != NEW6) OR (OLD7 != NEW7) OR (OLD8 != NEW8) OR (OLD9 != NEW9) OR (OLD10 != NEW10) OR
                (OLD11 != NEW11) OR (OLD12 != NEW12) OR (OLD13 != NEW13)
            )THEN
            BEGIN
                FOR
                    SELECT DISTINCT TRIM(SEGMENTS.RDB$FIELD_NAME) FROM RDB$RELATION_CONSTRAINTS CONSTRAINTS
                    LEFT JOIN RDB$INDICES INDICES ON CONSTRAINTS.RDB$INDEX_NAME = INDICES.RDB$INDEX_NAME
                    LEFT JOIN RDB$INDEX_SEGMENTS SEGMENTS ON INDICES.RDB$INDEX_NAME = SEGMENTS.RDB$INDEX_NAME
                    WHERE TRIM(CONSTRAINTS.RDB$RELATION_NAME) = :VTABELA
                    AND CONSTRAINTS.RDB$CONSTRAINT_TYPE IN ('PRIMARY KEY', 'FOREIGN KEY')
                    INTO :VKEY
                DO
                BEGIN VKEYS = COALESCE(VKEYS, '') || VKEY || ';'; END
                
                IF (OLD1 = NEW1 AND POSITION(FIELD1 || ';' IN VKEYS) = 0) THEN BEGIN OLD1 = NULL; NEW1 = NULL; END
                IF (OLD2 = NEW2 AND POSITION(FIELD2 || ';' IN VKEYS) = 0) THEN BEGIN OLD2 = NULL; NEW2 = NULL; END
                IF (OLD3 = NEW3 AND POSITION(FIELD3 || ';' IN VKEYS) = 0) THEN BEGIN OLD3 = NULL; NEW3 = NULL; END
                IF (OLD4 = NEW4 AND POSITION(FIELD4 || ';' IN VKEYS) = 0) THEN BEGIN OLD4 = NULL; NEW4 = NULL; END
                IF (OLD5 = NEW5 AND POSITION(FIELD5 || ';' IN VKEYS) = 0) THEN BEGIN OLD5 = NULL; NEW5 = NULL; END
                IF (OLD6 = NEW6 AND POSITION(FIELD6 || ';' IN VKEYS) = 0) THEN BEGIN OLD6 = NULL; NEW6 = NULL; END
                IF (OLD7 = NEW7 AND POSITION(FIELD7 || ';' IN VKEYS) = 0) THEN BEGIN OLD7 = NULL; NEW7 = NULL; END
                IF (OLD8 = NEW8 AND POSITION(FIELD8 || ';' IN VKEYS) = 0) THEN BEGIN OLD8 = NULL; NEW8 = NULL; END
                IF (OLD9 = NEW9 AND POSITION(FIELD9 || ';' IN VKEYS) = 0) THEN BEGIN OLD9 = NULL; NEW9 = NULL; END
                IF (OLD10 = NEW10 AND POSITION(FIELD10 || ';' IN VKEYS) = 0) THEN BEGIN OLD10 = NULL; NEW10 = NULL; END
                IF (OLD11 = NEW11 AND POSITION(FIELD11 || ';' IN VKEYS) = 0) THEN BEGIN OLD11 = NULL; NEW11 = NULL; END
                IF (OLD12 = NEW12 AND POSITION(FIELD12 || ';' IN VKEYS) = 0) THEN BEGIN OLD12 = NULL; NEW12 = NULL; END
                IF (OLD13 = NEW13 AND POSITION(FIELD13 || ';' IN VKEYS) = 0) THEN BEGIN OLD13 = NULL; NEW13 = NULL; END

                INSERT INTO LOGTABELAPRECO(LTPTABELA, LTPUSUCODIGO, LTPLOCAL, LTPACAO,
                LTPCAMPO1,  LTPANTVALOR1,  LTPNOVOVALOR1,  LTPCAMPO2,  LTPANTVALOR2,  LTPNOVOVALOR2,
                LTPCAMPO3,  LTPANTVALOR3,  LTPNOVOVALOR3,  LTPCAMPO4,  LTPANTVALOR4,  LTPNOVOVALOR4,
                LTPCAMPO5,  LTPANTVALOR5,  LTPNOVOVALOR5,  LTPCAMPO6,  LTPANTVALOR6,  LTPNOVOVALOR6,
                LTPCAMPO7,  LTPANTVALOR7,  LTPNOVOVALOR7,  LTPCAMPO8,  LTPANTVALOR8,  LTPNOVOVALOR8,
                LTPCAMPO9,  LTPANTVALOR9,  LTPNOVOVALOR9,  LTPCAMPO10, LTPANTVALOR10, LTPNOVOVALOR10,
                LTPCAMPO11, LTPANTVALOR11, LTPNOVOVALOR11, LTPCAMPO12, LTPANTVALOR12, LTPNOVOVALOR12,
                LTPCAMPO13, LTPANTVALOR13, LTPNOVOVALOR13
                ) VALUES (:VTABELA, :VUSUARIO, :VLOCAL, :VACAO,
                :FIELD1,  :OLD1,     :NEW1,   :FIELD2,  :OLD2,  :NEW2,  :FIELD3,  :OLD3,  :NEW3,
                :FIELD4,  :OLD4,     :NEW4,   :FIELD5,  :OLD5,  :NEW5,  :FIELD6,  :OLD6,  :NEW6,
                :FIELD7,  :OLD7,     :NEW7,   :FIELD8,  :OLD8,  :NEW8,  :FIELD9,  :OLD9,  :NEW9,
                :FIELD10, :OLD10,    :NEW10,  :FIELD11, :OLD11, :NEW11, :FIELD12, :OLD12, :NEW12,
                :FIELD13, :OLD13,    :NEW13
                );
            END
        END
        ELSE
        BEGIN
            INSERT INTO LOGTABELAPRECO(LTPTABELA, LTPUSUCODIGO, LTPLOCAL, LTPACAO,
            LTPCAMPO1,  LTPANTVALOR1,  LTPNOVOVALOR1,  LTPCAMPO2,  LTPANTVALOR2,  LTPNOVOVALOR2,
            LTPCAMPO3,  LTPANTVALOR3,  LTPNOVOVALOR3,  LTPCAMPO4,  LTPANTVALOR4,  LTPNOVOVALOR4,
            LTPCAMPO5,  LTPANTVALOR5,  LTPNOVOVALOR5,  LTPCAMPO6,  LTPANTVALOR6,  LTPNOVOVALOR6,
            LTPCAMPO7,  LTPANTVALOR7,  LTPNOVOVALOR7,  LTPCAMPO8,  LTPANTVALOR8,  LTPNOVOVALOR8,
            LTPCAMPO9,  LTPANTVALOR9,  LTPNOVOVALOR9,  LTPCAMPO10, LTPANTVALOR10, LTPNOVOVALOR10,
            LTPCAMPO11, LTPANTVALOR11, LTPNOVOVALOR11, LTPCAMPO12, LTPANTVALOR12, LTPNOVOVALOR12,
            LTPCAMPO13, LTPANTVALOR13, LTPNOVOVALOR13
            ) VALUES (:VTABELA, :VUSUARIO, :VLOCAL, :VACAO,
            :FIELD1,  :OLD1,     :NEW1,   :FIELD2,  :OLD2,  :NEW2,  :FIELD3,  :OLD3,  :NEW3,
            :FIELD4,  :OLD4,     :NEW4,   :FIELD5,  :OLD5,  :NEW5,  :FIELD6,  :OLD6,  :NEW6,
            :FIELD7,  :OLD7,     :NEW7,   :FIELD8,  :OLD8,  :NEW8,  :FIELD9,  :OLD9,  :NEW9,
            :FIELD10, :OLD10,    :NEW10,  :FIELD11, :OLD11, :NEW11, :FIELD12, :OLD12, :NEW12,
            :FIELD13, :OLD13,    :NEW13
            );
        END
    END
END^ SET TERM ; ^ COMMIT;

/* CRIA AS TRIGGERS QUE DISPARAM A AUDITORIA SEMPRE QUE HOUVER INSERT/UPDATE/DELETE DAS TABELAS
ESSAS TRIGGERS NAO DEVEM CONTER LOGICA DE AUDITORIA, APENAS ENVIO DOS DADOS PARA A PROCEDURE LOGTABELAPRECO_AIUD0 */
EXECUTE BLOCK AS DECLARE VARIABLE VTABELA VARCHAR(64); DECLARE VARIABLE VCMD BLOB SUB_TYPE 1;
BEGIN FOR SELECT TABELA FROM LOGTABELA INTO :VTABELA DO BEGIN
VCMD = 'CREATE OR ALTER TRIGGER ' || VTABELA || '_AIUD0 FOR ' || VTABELA || '
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0 AS
    DECLARE VARIABLE VTABELA VARCHAR(64); 
    DECLARE VARIABLE VUSUARIO INTEGER; 
    DECLARE VARIABLE VACAO CHAR(1); 
BEGIN 
    :VTABELA = ''' || VTABELA || ''';
    SELECT FIRST 1 USUCODIGO FROM USUARIO WHERE USUNOME = (SELECT CONTEXT_VALUE FROM GET_USER_SESSION(''USUARIO'')) INTO :VUSUARIO;
    IF (:VUSUARIO IS NULL) THEN :VUSUARIO = 1;
    IF (INSERTING) THEN :VACAO = ''I''; ELSE IF (UPDATING) THEN :VACAO = ''U''; ELSE :VACAO = ''D'';
    
/*$*$*/

END'; EXECUTE STATEMENT VCMD; END END; COMMIT;

/* ALTERA AS TRIGGER ADICIONANDO OS CAMPOS QUE SERAO ENVIADOS PARA A PROCEDURE
SUBSTITUI O MARCADOR $*$ PELO RESTANTE DAS TRIGGERS DE FORMA DINAMICA */
EXECUTE BLOCK AS
    DECLARE VARIABLE TABELA VARCHAR(64);
    DECLARE VARIABLE CAMPOS VARCHAR(2000);
    DECLARE VARIABLE POSICAO_INICIO INTEGER;
    DECLARE VARIABLE POSICAO_SEPARADOR INTEGER;
    DECLARE VARIABLE CAMPO VARCHAR(200);
    DECLARE VARIABLE TRECHO_LOG BLOB SUB_TYPE 1;
    DECLARE VARIABLE TRIGGER_BODY BLOB SUB_TYPE 1;
    DECLARE VARIABLE TRIGGER_HEADER VARCHAR(500);
    DECLARE VARIABLE SQL_FINAL BLOB SUB_TYPE 1;
BEGIN
  FOR SELECT TABELA, CAMPO FROM LOGTABELA INTO :TABELA, :CAMPOS DO
  BEGIN
      TRECHO_LOG = '    EXECUTE PROCEDURE LOGTABELAPRECO_AIUD0(:VTABELA, :VUSUARIO, :VACAO,' || ASCII_CHAR(10);
      POSICAO_INICIO = 1;
      WHILE (POSICAO_INICIO <= CHAR_LENGTH(CAMPOS)) DO
      BEGIN
          POSICAO_SEPARADOR = POSITION(';' IN SUBSTRING(CAMPOS FROM POSICAO_INICIO));
          IF (POSICAO_SEPARADOR = 0) THEN POSICAO_SEPARADOR = CHAR_LENGTH(CAMPOS) - POSICAO_INICIO + 2;
          CAMPO = TRIM(SUBSTRING(CAMPOS FROM POSICAO_INICIO FOR POSICAO_SEPARADOR - 1));
          IF (CAMPO <> '') THEN BEGIN
            TRECHO_LOG = TRECHO_LOG ||
              '        ''' || CAMPO ||
              ''', COALESCE(OLD.' || CAMPO ||
              ', NULL), COALESCE(NEW.' || CAMPO ||
              ', NULL),' || ASCII_CHAR(10);
          END
          POSICAO_INICIO = POSICAO_INICIO + POSICAO_SEPARADOR;
      END
      TRECHO_LOG = LEFT(TRECHO_LOG, CHAR_LENGTH(TRECHO_LOG) - 2) || ASCII_CHAR(10) || '    );';
      SELECT RDB$TRIGGER_SOURCE FROM RDB$TRIGGERS WHERE RDB$TRIGGER_NAME = :TABELA || '_AIUD0' INTO :TRIGGER_BODY;
      TRIGGER_HEADER =
            'CREATE OR ALTER TRIGGER ' || TABELA || '_AIUD0' || ASCII_CHAR(10) ||
            'FOR ' || TABELA || ASCII_CHAR(10) ||
            'ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0' || ASCII_CHAR(10);
      TRIGGER_BODY = REPLACE(TRIGGER_BODY, '/*$*$*/', TRECHO_LOG);
      SQL_FINAL = TRIGGER_HEADER || TRIGGER_BODY;
      EXECUTE STATEMENT SQL_FINAL;
  END END; COMMIT;
